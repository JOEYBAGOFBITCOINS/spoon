<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>IS THERE OR ISN&#39;T THERE?</title>
    <link rel="stylesheet" href="./style.css">

  </head>
    
  <body>
  <canvas id="canvas"></canvas>
<textarea id="codeEditor" class="editor" spellcheck="false" autocorrect="off" autocapitalize="off" translate="no" oninput="render()"></textarea>
<pre id="error"></pre>
<div id="indicator"></div>
<div id="controls">
	<div class="controls">
		<input id="btnToggleView" class="icon" type="checkbox" name="toggleView" onclick="toggleView()">
		<input id="btnToggleResolution" class="icon" type="checkbox" name="toggleResolution" onchange="toggleResolution()">
		<input id="btnReset" class="icon" type="checkbox" name="reset" onclick="reset()">
	</div>
</div>
<script type="x-shader/x-fragment">#version 300 es
/*********
** made by Joey & Seshat_INIAC INC.
* Textures made by Backward 7evin.
* http://www.Seshat.online
* http://joeybagofbitcoins.com
*/
precision highp float;
out vec4 O;
uniform float time;
uniform vec2 resolution;
uniform vec2 touch;
uniform int pointerCount;
uniform sampler2D wood;
uniform samplerCube cubeMap;
#define P pointerCount
#define mouse (touch/R)
#define FC gl_FragCoord.xy
#define R resolution
#define T time
#define N normalize
#define S smoothstep
#define MN min(R.x,R.y)
#define rot(a) mat2(cos((a)-vec4(0,11,33,0)))
struct Material {
	float dist;
	vec3 col;
	float rough;
	int id;
	bool hit;
};
float smin(float a, float b, float k) {
	float h=clamp(.5+.5*(b-a)/k,.0,1.);
	return mix(b,a,h)-k*h*(1.-h);
}
Material matmin(Material a, Material b) {
	if (a.dist<b.dist) return a;
	return b;
}
float egg(vec3 p, vec3 s) {
	s.xz+=-p.y*.085;
	s=abs(s);
	return (length(p/s)-1.)*min(min(s.x,s.y),s.z);
}
float box(vec3 p, vec3 s) {
	p=abs(p)-s;
	return length(max(p,.0))+min(.0,max(max(p.x,p.y),p.z));
}
float popstick(vec3 p, vec3 s) {
	p.y-=clamp(p.y,-s.y/2.,s.y/2.);
	float d=length(p.xy)-s.x;
	vec2 c=vec2(d,abs(p.z)-s.z);
	return length(max(c,.0))+min(.0,max(c.x,c.y));
}
float grip(vec3 p) {
	p.y+=2.65;
	p.yz*=rot(-.7);
	p.z+=.2-.8*sin(p.y*1.-2.7);
	return popstick(p,vec3(.15-.05*sin(p.y*1.4+.5),3,.01))-.02;
}
Material table(vec3 p) {
	float k=20.;
	p.y+=smin(sin(p.x*k),cos(p.z*k),-.1)*.004;
	float d=box(p+vec3(0,1,0),vec3(4,.5,4)-.1)-.1;
	p.x+=1.;
	p.z-=1.;
	return Material(d,texture(wood,p.xz/9.).rgb,.8,0,false);
}
Material spoon(vec3 p) {
	p.y-=.19;
	p.z-=2.5;
	p.yz*=rot(-1.265);
	p.xy*=rot(.2);
	float d=egg(p,vec3(.6,1,.6));
	d=abs(d)-.01;
	d=smin(d,-(p.z-.2),-.025);
	d=smin(d,grip(p),.05);
	d*=.8;
	return Material(d,vec3(.8,.9,1),.25,1,false);
}
Material map(vec3 p) {
	Material a=spoon(p), b=table(p);
	a=matmin(a,b);
	return a;
}
vec3 norm(vec3 p) {
	float h=1e-3; vec2 k=vec2(-1,1);
	return N(
		k.xyy*map(p+k.xyy*h).dist+
		k.yxy*map(p+k.yxy*h).dist+
		k.yyx*map(p+k.yyx*h).dist+
		k.xxx*map(p+k.xxx*h).dist
	);
}
Material march(inout vec3 p, vec3 rd) {
	Material mat;
	for (float i; i++<400.;) {
		mat=map(p);
		if (abs(mat.dist)<1e-3) {
			mat.hit=true;
			break;
		}
		if (mat.dist>300.) break;
		p+=rd*mat.dist;
	}
	return mat;
}
float shadow(vec3 p, vec3 lp, out vec3 mat) {
	if (p.y>2.) return 1.;
	float shd=1., maxd=length(lp-p);
	vec3 l=N(lp-p);
	for (float i=1e-2; i<maxd;) {
		Material d=map(p+l*i);
		if (abs(d.dist)<1e-2) {
			shd=.0;
			mat=d.col;
			break;
		}
		shd=min(shd,64.*d.dist/i);
		i+=d.dist;
	}
	return shd;
}
float calcAO(vec3 p, vec3 n) {
	float occ=.0, sca=1.;
	for (float i=.0; i<5.; i++) {
		float
		h=.01+i*.09,
		d=map(p+h*n).dist;
		occ+=(h-d)*sca;
		sca*=.55;
		if (occ>.35) break;
	}
	return clamp(1.-3.*occ,.0,1.)*(.5+.5*n.y);
}
vec3 render(inout vec3 p, vec3 rd, out Material mat, bool refl) {
	vec3 col=vec3(0);
	mat=march(p,rd);
	if (mat.hit) {
		vec3 n=norm(p), lp=vec3(1,3,-2), l=N(lp-p), hal=N(lp)-n, smat;
		float dif=clamp(dot(l,n),.0,1.), fres=clamp(1.+dot(rd,n),.0,1.),
		spec=pow(clamp(dot(hal,rd),.0,1.),2.), spe=pow(clamp(dot(reflect(rd,n),l),.0,1.),32.),
		shd=shadow(p+5e-2*n,lp,smat), ao=calcAO(p,n), ld=distance(lp,p);
		col+=.1*mat.col+dif*mat.col;
		col=mix(mix(col*.25,smat*.2,1./(1.+ld*.5+ld*ld*5e-1)),col,max(shd,.6*sqrt(ao)));
		col+=spec+spe*(1.-mat.rough)*shd;
		if (!refl) {
			vec3 c=mix(col,4.*texture(cubeMap,reflect(rd,n)).rgb,(1.-mat.rough));
			c=pow(c,vec3(.4545));
			col+=c*float(mat.id);
		}
	} else {
		if (!refl) {
			vec3 c=texture(cubeMap,rd).rgb;
			c=pow(c,vec3(.4545));
			col+=c*2.;
		}
	}
	return col;
}
void cam(inout vec3 p) {
	float t=T;
	if (P>0) {
		p.yz*=rot(-sin(mouse.y*6.3+3.14)*.7+.7);
		p.xz*=rot(6.3-mouse.x*12.6);
	} else {
		p.yz*=rot(.78-.7*(cos(t*.5)*.5+.5));
		p.xz*=rot(-.56+.1*t);
		p.xy*=rot(-.1*sin(t));
	}
}
void main() {
	vec2 uv=(FC-.5*R)/MN;
	vec3 col=vec3(0),
	p=vec3(0,0,-4),
	rd=N(vec3(uv,1));
	cam(p); cam(rd);
	Material mat,dmat;
	col+=render(p,rd,mat,false);
	vec3 n=norm(p);
	float fres=pow(clamp(1.+dot(rd,n),.0,5.),5.);
	p+=5e-2*n;
	rd=reflect(rd,n);
	vec3 c=render(p,rd,dmat,true);
	col=mix(col,c*(1.-mat.rough),(1.-mat.rough));
	O=vec4(col,1);
}</script>
    <script  src="./script.js"></script>

  </body>
  
</html>
